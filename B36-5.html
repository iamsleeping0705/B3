import React, { useState, useEffect, useRef } from 'react';
import { Play, CheckCircle, XCircle, Award, ArrowRight, User, Hash, FlaskConical, Atom, GripVertical, RefreshCw, Beaker, Save, AlertTriangle, FastForward } from 'lucide-react';

/**
 * ============================================================================
 * ã€Google Apps Script è¨­å®šèªªæ˜ã€‘
 * * è‹¥è¦å•Ÿç”¨æˆç¸¾ä¸Šå‚³åŠŸèƒ½ï¼Œè«‹æŒ‰ç…§ä»¥ä¸‹æ­¥é©Ÿï¼š
 * 1. å»ºç«‹ä¸€å€‹ Google Sheetï¼Œç¬¬ä¸€åˆ—æ¨™é¡Œå¡«å…¥ï¼štimestamp, classId, seatId, level, score, mistakes
 * 2. é»é¸ã€Œæ“´å……åŠŸèƒ½ã€>ã€ŒApps Scriptã€ï¼Œè²¼ä¸Šä»¥ä¸‹ç¨‹å¼ç¢¼ï¼š
 * * function doPost(e) {
 * var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
 * var data = JSON.parse(e.postData.contents);
 * sheet.appendRow([data.timestamp, data.classId, data.seatId, data.level, data.score, data.mistakes]);
 * return ContentService.createTextOutput("Success");
 * }
 * * 3. é»é¸ã€Œéƒ¨ç½²ã€>ã€Œæ–°å¢éƒ¨ç½²ã€> é¡å‹é¸ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€> å­˜å–æ¬Šé™é¸ã€Œæ‰€æœ‰äºº(Anyone)ã€ã€‚
 * 4. è¤‡è£½å¾—åˆ°çš„ URLï¼Œå¡«å…¥ä¸‹æ–¹çš„ GOOGLE_SCRIPT_URL è®Šæ•¸ä¸­ã€‚
 * ============================================================================
 */

// è«‹å°‡éƒ¨ç½²å¥½çš„ Web App URL å¡«å…¥ä¸‹æ–¹å¼•è™Ÿä¸­
const GOOGLE_SCRIPT_URL = ""; 

// --- SVG Components for Particle Models ---

const AtomModel = ({ color = "#ef4444", label }) => (
  <svg viewBox="0 0 50 50" className="w-10 h-10 md:w-12 md:h-12 inline-block drop-shadow-md">
    <circle cx="25" cy="25" r="12" fill={color} stroke="#333" strokeWidth="1.5" />
    <circle cx="20" cy="20" r="3" fill="white" fillOpacity="0.3" />
    {label && <text x="25" y="25" textAnchor="middle" dy=".3em" fontSize="10" fill="white" fontWeight="bold">{label}</text>}
  </svg>
);

const DiatomicModel = ({ color = "#3b82f6" }) => (
  <svg viewBox="0 0 60 40" className="w-12 h-8 md:w-14 md:h-10 inline-block drop-shadow-md">
    <g>
      <circle cx="20" cy="20" r="10" fill={color} stroke="#333" strokeWidth="1.5" />
      <circle cx="40" cy="20" r="10" fill={color} stroke="#333" strokeWidth="1.5" />
    </g>
  </svg>
);

const TriatomicModel = ({ color = "#ef4444" }) => (
  <svg viewBox="0 0 60 50" className="w-12 h-10 md:w-14 md:h-12 inline-block drop-shadow-md">
    <g transform="translate(5,5)">
      <circle cx="10" cy="30" r="9" fill={color} stroke="#333" strokeWidth="1.5" />
      <circle cx="25" cy="10" r="9" fill={color} stroke="#333" strokeWidth="1.5" />
      <circle cx="40" cy="30" r="9" fill={color} stroke="#333" strokeWidth="1.5" />
    </g>
  </svg>
);

const WaterModel = () => (
  <svg viewBox="0 0 50 50" className="w-10 h-10 md:w-12 md:h-12 inline-block drop-shadow-md">
    <g transform="translate(5,5)">
      <circle cx="10" cy="12" r="7" fill="#cbd5e1" stroke="#333" strokeWidth="1.5" />
      <circle cx="38" cy="12" r="7" fill="#cbd5e1" stroke="#333" strokeWidth="1.5" />
      <circle cx="24" cy="28" r="12" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
    </g>
  </svg>
);

const LinearMolecule = ({ type = 'tri' }) => (
  <svg viewBox="0 0 70 40" className="w-14 h-8 md:w-16 md:h-10 inline-block drop-shadow-md">
    <g transform="translate(5,0)">
      {type === 'tri' ? (
        <>
          <circle cx="10" cy="20" r="9" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
          <circle cx="30" cy="20" r="10" fill="#333" stroke="#333" strokeWidth="1.5" />
          <circle cx="50" cy="20" r="9" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
        </>
      ) : (
        <>
           <circle cx="20" cy="20" r="10" fill="#333" stroke="#333" strokeWidth="1.5" />
           <circle cx="40" cy="20" r="9" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
        </>
      )}
    </g>
  </svg>
);

const MixtureModel = ({ color = "#ef4444" }) => (
  <svg viewBox="0 0 60 60" className="w-12 h-12 md:w-14 md:h-14 inline-block bg-white/50 rounded-full border border-dashed border-gray-400 p-1">
    <circle cx="15" cy="15" r="5" fill={color} />
    <circle cx="45" cy="45" r="5" fill={color} />
    <circle cx="45" cy="15" r="6" fill="#3b82f6" />
    <circle cx="15" cy="45" r="4" fill="#22c55e" />
  </svg>
);

// --- Game Data ---

const classificationData = [
  // Elements
  { id: 'c1', name: 'æ°§æ°£', formula: 'Oâ‚‚', type: 'element', icon: <DiatomicModel color="#3b82f6" /> },
  { id: 'c4', name: 'éŠ…ç·š', formula: 'Cu', type: 'element', icon: <AtomModel color="#d97706" /> },
  { id: 'c7', name: 'æ°¦æ°£', formula: 'He', type: 'element', icon: <AtomModel color="#a855f7" /> },
  { id: 'c9', name: 'éµé‡˜', formula: 'Fe', type: 'element', icon: <AtomModel color="#64748b" /> },
  { id: 'c10', name: 'é»ƒé‡‘', formula: 'Au', type: 'element', icon: <AtomModel color="#fbbf24" /> },
  { id: 'c13', name: 'é‘½çŸ³', formula: 'C', type: 'element', icon: <AtomModel color="#bae6fd" /> },
  { id: 'c18', name: 'æ°¬æ°£', formula: 'Ar', type: 'element', icon: <AtomModel color="#10b981" /> },
  { id: 'c19', name: 'è‡­æ°§', formula: 'Oâ‚ƒ', type: 'element', icon: <TriatomicModel color="#3b82f6" /> },

  // Compounds
  { id: 'c2', name: 'æ°´', formula: 'Hâ‚‚O', type: 'compound', icon: <WaterModel /> },
  { id: 'c5', name: 'äºŒæ°§åŒ–ç¢³', formula: 'COâ‚‚', type: 'compound', icon: <LinearMolecule type="tri" /> },
  { id: 'c8', name: 'é£Ÿé¹½(æ°¯åŒ–éˆ‰)', formula: 'NaCl', type: 'compound', icon: <div className="flex gap-1 items-center"><AtomModel color="#22c55e" label="Cl" /><AtomModel color="#64748b" label="Na" /></div> },
  { id: 'c11', name: 'ç´”é…’ç²¾', formula: 'Câ‚‚Hâ‚…OH', type: 'compound', icon: <FlaskConical className="w-10 h-10 text-purple-400" /> },
  { id: 'c14', name: 'ä¹¾å†°', formula: 'COâ‚‚', type: 'compound', icon: <div className="relative"><LinearMolecule type="tri" /><span className="absolute -top-2 -right-2 text-xs">ğŸ’¨</span></div> },
  { id: 'c15', name: 'æ°¨æ°£', formula: 'NHâ‚ƒ', type: 'compound', icon: <AtomModel color="#fcd34d" label="N" /> },
  { id: 'c20', name: 'ä¸€æ°§åŒ–ç¢³', formula: 'CO', type: 'compound', icon: <LinearMolecule type="di" /> },

  // Mixtures
  { id: 'c3', name: 'ç©ºæ°£', formula: 'Air', type: 'mixture', icon: <MixtureModel /> },
  { id: 'c6', name: 'ç³–æ°´', formula: 'Sugar Water', type: 'mixture', icon: <Beaker className="w-10 h-10 text-orange-400" /> },
  { id: 'c12', name: 'é¹½é…¸', formula: 'HCl(aq)', type: 'mixture', icon: <FlaskConical className="w-10 h-10 text-yellow-500" /> },
  { id: 'c16', name: 'é›™æ°§æ°´', formula: 'Hâ‚‚Oâ‚‚(aq)', type: 'mixture', icon: <FlaskConical className="w-10 h-10 text-blue-300" /> },
  { id: 'c17', name: 'å¢¨æ°´', formula: 'Ink', type: 'mixture', icon: <div className="w-10 h-10 bg-black rounded-full border-2 border-gray-400 opacity-80" /> },
];

const matchingData = [
  // Original 9 Items
  { id: 'm1', formula: 'Hâ‚‚O', name: 'æ°´', model: <WaterModel /> },
  { id: 'm2', formula: 'COâ‚‚', name: 'äºŒæ°§åŒ–ç¢³', model: <LinearMolecule type="tri" /> },
  { id: 'm3', formula: 'Oâ‚‚', name: 'æ°§æ°£', model: <DiatomicModel color="#3b82f6" /> },
  { id: 'm4', formula: 'NaCl', name: 'æ°¯åŒ–éˆ‰', model: <div className="flex items-center justify-center scale-75"><AtomModel color="#64748b" /><AtomModel color="#22c55e" /></div> },
  { id: 'm5', formula: 'Câ‚†Hâ‚â‚‚Oâ‚†', name: 'è‘¡è„ç³–', model: <span className="text-2xl">ğŸ¬</span> },
  { id: 'm6', formula: 'Mg', name: 'é‚', model: <AtomModel color="#94a3b8" label="Mg" /> },
  { id: 'm7', formula: 'Ar', name: 'æ°¬æ°£', model: <AtomModel color="#10b981" label="Ar" /> },
  { id: 'm8', formula: 'Oâ‚ƒ', name: 'è‡­æ°§', model: <TriatomicModel color="#3b82f6" /> },
  { id: 'm9', formula: 'CO', name: 'ä¸€æ°§åŒ–ç¢³', model: <LinearMolecule type="di" /> },
  
  // New Items (Total 16)
  { id: 'm10', formula: 'Nâ‚‚', name: 'æ°®æ°£', model: <DiatomicModel color="#94a3b8" /> },
  { id: 'm11', formula: 'Hâ‚‚', name: 'æ°«æ°£', model: <DiatomicModel color="#cbd5e1" /> },
  { id: 'm12', formula: 'Fe', name: 'éµ', model: <AtomModel color="#475569" label="Fe" /> },
  { id: 'm13', formula: 'Cu', name: 'éŠ…', model: <AtomModel color="#d97706" label="Cu" /> },
  { id: 'm14', formula: 'Au', name: 'é‡‘', model: <AtomModel color="#fbbf24" label="Au" /> },
  { id: 'm15', formula: 'He', name: 'æ°¦æ°£', model: <AtomModel color="#a855f7" label="He" /> },
  { id: 'm16', formula: 'Clâ‚‚', name: 'æ°¯æ°£', model: <DiatomicModel color="#22c55e" /> },
];

export default function MatterQuizApp() {
  const [screen, setScreen] = useState('welcome');
  const [userInfo, setUserInfo] = useState({ classId: '', seatId: '' });
  const [score, setScore] = useState(100);
  const [mistakeHistory, setMistakeHistory] = useState([]); // ç´€éŒ„éŒ¯èª¤ { item: 'æ°´', wrong: 'å…ƒç´ ', correct: 'åŒ–åˆç‰©' }
  const [submissionStatus, setSubmissionStatus] = useState('idle'); // idle, submitting, success, error
  const [isCombinedSession, setIsCombinedSession] = useState(false); // Track if user is doing full run
  
  // Drag & Drop State
  const [draggedItem, setDraggedItem] = useState(null);
  const [items, setItems] = useState([]);
  const [droppedItems, setDroppedItems] = useState([]); 
  const [matchedPairs, setMatchedPairs] = useState({});
  const [feedback, setFeedback] = useState(null);

  // Level 1: Bins
  const bins = [
    { id: 'element', label: 'å…ƒç´ ', color: 'bg-blue-50 border-blue-500 text-blue-800' },
    { id: 'compound', label: 'åŒ–åˆç‰©', color: 'bg-green-50 border-green-500 text-green-800' },
    { id: 'mixture', label: 'æ··åˆç‰©', color: 'bg-orange-50 border-orange-500 text-orange-800' },
  ];

  // --- Logic ---

  const handleStart = () => {
    if (userInfo.classId && userInfo.seatId) {
      setScreen('levels');
    } else {
      alert("è«‹è¼¸å…¥ç­ç´šèˆ‡åº§è™Ÿï¼");
    }
  };

  const initLevel1 = () => {
    setItems([...classificationData].sort(() => Math.random() - 0.5));
    setDroppedItems([]);
    setScore(100); // Always restart score for Level 1
    setMistakeHistory([]); // Always restart history
    setIsCombinedSession(true); // Start of a combined session
    setSubmissionStatus('idle');
    setScreen('game-level-1');
    setFeedback(null);
  };

  // Modified initLevel2 to handle continuation
  const initLevel2 = (isContinuation = false) => {
    setItems([...matchingData].sort(() => Math.random() - 0.5));
    setMatchedPairs({});
    
    if (!isContinuation) {
        // If independent start
        setScore(100);
        setMistakeHistory([]);
        setIsCombinedSession(false);
    }
    // If continuing, keep score and history
    
    setSubmissionStatus('idle');
    setScreen('game-level-2');
    setFeedback(null);
  };

  // Google Sheet Submission Logic
  const submitScore = async () => {
    if (!GOOGLE_SCRIPT_URL) {
      alert("è«‹å…ˆè¨­å®š Google Apps Script URL (è«‹è¦‹ç¨‹å¼ç¢¼æœ€ä¸Šæ–¹èªªæ˜) æ‰èƒ½å•Ÿç”¨ä¸Šå‚³åŠŸèƒ½ã€‚");
      return;
    }

    setSubmissionStatus('submitting');
    
    // Determine Level Label
    let levelLabel = 'Level 2 Only';
    if (screen === 'summary-1') levelLabel = 'Level 1 Only';
    if (screen === 'summary-2' && isCombinedSession) levelLabel = 'Full Challenge (L1+L2)';

    // Data payload
    const data = {
      timestamp: new Date().toISOString(),
      classId: userInfo.classId,
      seatId: userInfo.seatId,
      level: levelLabel,
      score: score,
      mistakes: JSON.stringify(mistakeHistory.map(m => m.item))
    };

    try {
      // Use no-cors mode for simple submission to Google Apps Script
      await fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });
      setSubmissionStatus('success');
    } catch (error) {
      console.error("Submission error", error);
      setSubmissionStatus('error');
    }
  };

  // Drag Handlers
  const handleDragStart = (e, item) => {
    setDraggedItem(item);
    e.dataTransfer.setData('text/plain', item.id);
    e.dataTransfer.effectAllowed = 'move';
  };

  const handleDragOver = (e) => {
    e.preventDefault();
  };

  // Level 1 Drop Logic
  const handleDropLevel1 = (e, binType) => {
    e.preventDefault();
    if (!draggedItem) return;

    if (draggedItem.type === binType) {
      // Correct
      setDroppedItems(prev => [...prev, draggedItem]);
      setItems(prev => prev.filter(i => i.id !== draggedItem.id));
      setFeedback({ type: 'success', msg: 'ç­”å°äº†ï¼' });
      // Score doesn't increase, starts at 100
      setTimeout(() => setFeedback(null), 800);
      
      // Check if finished
      if (items.length <= 1) { 
         setTimeout(() => setScreen('summary-1'), 1500);
      }
    } else {
      // Incorrect
      setScore(prev => Math.max(0, prev - 2)); // Deduct 2 points
      setFeedback({ type: 'error', msg: 'åˆ†é¡éŒ¯èª¤ï¼Œæ‰£ 2 åˆ†ï¼' });
      
      // Record Mistake
      const binLabel = bins.find(b => b.id === binType).label;
      const correctLabel = bins.find(b => b.id === draggedItem.type).label;
      
      setMistakeHistory(prev => [
        ...prev, 
        { 
          item: draggedItem.name, 
          wrong: binLabel, 
          correct: correctLabel 
        }
      ]);
      
      setTimeout(() => setFeedback(null), 1500);
    }
    setDraggedItem(null);
  };

  // Level 2 Drop Logic
  const handleDropLevel2 = (e, targetId) => {
    e.preventDefault();
    if (!draggedItem) return;

    if (draggedItem.id === targetId) {
      // Correct
      setMatchedPairs(prev => ({ ...prev, [targetId]: draggedItem }));
      setItems(prev => prev.filter(i => i.id !== draggedItem.id));
      setFeedback({ type: 'success', msg: 'é…å°æˆåŠŸï¼' });
      setTimeout(() => setFeedback(null), 800);

       // Check if finished
      if (items.length <= 1) {
         setTimeout(() => setScreen('summary-2'), 1500);
      }
    } else {
      // Incorrect
      setScore(prev => Math.max(0, prev - 2));
      setFeedback({ type: 'error', msg: 'é…å°éŒ¯èª¤ï¼Œæ‰£ 2 åˆ†ï¼' });
      
      // Record Mistake
      const targetName = matchingData.find(m => m.id === targetId).name;
      const correctTarget = matchingData.find(m => m.id === draggedItem.id).name;
      
      setMistakeHistory(prev => [
        ...prev, 
        { 
          item: draggedItem.formula, 
          wrong: `é…å°çµ¦ ${targetName}`, 
          correct: correctTarget 
        }
      ]);

      setTimeout(() => setFeedback(null), 1500);
    }
    setDraggedItem(null);
  };

  // Common Click Handlers
  const handleItemClick = (item) => {
    if (draggedItem && draggedItem.id === item.id) {
      setDraggedItem(null); 
    } else {
      setDraggedItem(item); 
    }
  };

  const handleBinClick = (binType) => {
    if (draggedItem) {
      if (draggedItem.type === binType) {
        // ... (reuse logic from drop)
        setDroppedItems(prev => [...prev, draggedItem]);
        setItems(prev => prev.filter(i => i.id !== draggedItem.id));
        setFeedback({ type: 'success', msg: 'ç­”å°äº†ï¼' });
        setTimeout(() => setFeedback(null), 800);
        if (items.length <= 1) setTimeout(() => setScreen('summary-1'), 1500);
      } else {
        // ... (reuse logic)
        setScore(prev => Math.max(0, prev - 2));
        const binLabel = bins.find(b => b.id === binType).label;
        const correctLabel = bins.find(b => b.id === draggedItem.type).label;
        setMistakeHistory(prev => [...prev, { item: draggedItem.name, wrong: binLabel, correct: correctLabel }]);
        setFeedback({ type: 'error', msg: 'åˆ†é¡éŒ¯èª¤ï¼Œæ‰£ 2 åˆ†ï¼' });
        setTimeout(() => setFeedback(null), 1500);
      }
      setDraggedItem(null);
    }
  };

  const handleSlotClick = (targetId) => {
    if (draggedItem) {
      if (draggedItem.id === targetId) {
        setMatchedPairs(prev => ({ ...prev, [targetId]: draggedItem }));
        setItems(prev => prev.filter(i => i.id !== draggedItem.id));
        setFeedback({ type: 'success', msg: 'é…å°æˆåŠŸï¼' });
        setTimeout(() => setFeedback(null), 800);
        if (items.length <= 1) setTimeout(() => setScreen('summary-2'), 1500);
      } else {
         setScore(prev => Math.max(0, prev - 2));
         const targetName = matchingData.find(m => m.id === targetId).name;
         const correctTarget = matchingData.find(m => m.id === draggedItem.id).name;
         setMistakeHistory(prev => [...prev, { item: draggedItem.formula, wrong: `é…å°çµ¦ ${targetName}`, correct: correctTarget }]);
         setFeedback({ type: 'error', msg: 'é…å°éŒ¯èª¤ï¼Œæ‰£ 2 åˆ†ï¼' });
         setTimeout(() => setFeedback(null), 1500);
      }
      setDraggedItem(null);
    }
  }


  // --- Render Components ---

  const FeedbackToast = () => (
    <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg font-bold text-lg transition-all duration-300 z-50 flex items-center gap-2 ${
      feedback?.type === 'success' ? 'bg-green-500 text-white scale-110' : 
      feedback?.type === 'error' ? 'bg-red-500 text-white animate-pulse' : 'opacity-0'
    }`}>
      {feedback?.type === 'success' ? <CheckCircle /> : <XCircle />}
      {feedback?.msg}
    </div>
  );

  const SummaryScreen = ({ title, isIntermediate = false }) => (
    <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
      <div className="bg-white max-w-2xl w-full rounded-2xl shadow-xl overflow-hidden p-8">
        <div className="text-center mb-8">
          <Award size={64} className="mx-auto text-yellow-500 mb-4" />
          <h2 className="text-3xl font-black text-slate-800">{title} å®Œæˆï¼</h2>
          <div className="mt-4 text-6xl font-black text-indigo-600 tracking-tight">
            {score} <span className="text-2xl text-slate-400">åˆ†</span>
          </div>
          {isIntermediate && (
             <p className="text-slate-500 mt-2 font-bold">ç›®å‰åˆ†æ•¸ (å°‡å¸¶å…¥ä¸‹ä¸€é—œ)</p>
          )}
        </div>

        {/* Mistake Report */}
        <div className="mb-8">
          <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
            <AlertTriangle size={20} className="text-orange-500" />
            {isIntermediate ? "æœ¬é—œå­¸ç¿’å›é¥‹" : "å®Œæ•´å­¸ç¿’å›é¥‹"}
          </h3>
          {mistakeHistory.length === 0 ? (
            <div className="bg-green-50 text-green-700 p-4 rounded-xl text-center font-bold">
              å¤ªæ£’äº†ï¼æŒ‘æˆ°å®Œå…¨æ­£ç¢ºï¼Œæ²’æœ‰å¤±èª¤ï¼
            </div>
          ) : (
            <div className="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden max-h-60 overflow-y-auto">
              <table className="w-full text-left text-sm">
                <thead className="bg-slate-100 text-slate-500 sticky top-0">
                  <tr>
                    <th className="p-3">é¡Œç›®</th>
                    <th className="p-3">ä½ çš„å›ç­”</th>
                    <th className="p-3">æ­£ç¢ºç­”æ¡ˆ</th>
                  </tr>
                </thead>
                <tbody>
                  {mistakeHistory.map((m, idx) => (
                    <tr key={idx} className="border-t border-slate-200">
                      <td className="p-3 font-bold text-slate-700">{m.item}</td>
                      <td className="p-3 text-red-500">{m.wrong}</td>
                      <td className="p-3 text-green-600 font-bold">{m.correct}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
              <div className="p-3 bg-red-50 text-red-600 text-xs text-center border-t border-red-100">
                ç›®å‰å…±ç­”éŒ¯ {mistakeHistory.length} æ¬¡ï¼Œæ‰£ {mistakeHistory.length * 2} åˆ†
              </div>
            </div>
          )}
        </div>

        {/* Actions */}
        <div className="grid grid-cols-2 gap-4">
          {/* Intermediate (Level 1 End) Actions */}
          {isIntermediate ? (
             <>
               <button 
                 onClick={() => initLevel2(true)} // Continue with keeping score
                 className="col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-bold text-xl shadow-lg flex items-center justify-center gap-2 animate-pulse"
               >
                 <FastForward fill="currentColor" /> æŒ‘æˆ°ç¬¬äºŒé—œ (Level 2)
               </button>
               {/* Hidden option to quit early if really needed, but encouraged to continue */}
               <button 
                 onClick={() => setScreen('levels')}
                 className="col-span-2 text-slate-400 text-sm hover:text-slate-600"
               >
                 æš«åœä¸¦è¿”å›é¸å–®
               </button>
             </>
          ) : (
             /* Final Actions */
             <>
                <button 
                    onClick={submitScore}
                    disabled={submissionStatus === 'success' || submissionStatus === 'submitting'}
                    className={`flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-white transition
                    ${submissionStatus === 'success' ? 'bg-green-500 cursor-default' : 
                        submissionStatus === 'submitting' ? 'bg-gray-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700'}
                    `}
                >
                    {submissionStatus === 'idle' && <><Save size={20} /> ä¸Šå‚³ç¸½æˆç¸¾</>}
                    {submissionStatus === 'submitting' && <RefreshCw className="animate-spin" />}
                    {submissionStatus === 'success' && <><CheckCircle /> ä¸Šå‚³æˆåŠŸ</>}
                    {submissionStatus === 'error' && <><XCircle /> ä¸Šå‚³å¤±æ•—(è«‹é‡è©¦)</>}
                </button>
                
                <button 
                    onClick={() => setScreen('levels')}
                    className="border-2 border-slate-200 hover:bg-slate-50 text-slate-600 py-3 rounded-xl font-bold transition"
                >
                    å›åˆ°é¸å–®
                </button>
             </>
          )}
        </div>
      </div>
    </div>
  );

  // Screen: Welcome
  if (screen === 'welcome') {
    return (
      <div className="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
        <div className="bg-white/95 backdrop-blur-sm max-w-md w-full rounded-3xl shadow-2xl overflow-hidden border-4 border-white/50">
          <div className="bg-slate-800 p-8 text-center text-white relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-full opacity-10">
              <svg className="w-full h-full" viewBox="0 0 100 100">
                <circle cx="20" cy="20" r="15" fill="white" />
                <circle cx="80" cy="80" r="20" fill="white" />
              </svg>
            </div>
            <h1 className="text-4xl font-black mb-2 tracking-tight relative z-10">ç†åŒ–å¤§æŒ‘æˆ°</h1>
            <p className="text-indigo-200 font-medium relative z-10">ç‰©è³ªåˆ†é¡ & åŒ–å­¸é…å°</p>
            <div className="mt-4 inline-block bg-white/20 px-3 py-1 rounded-full text-xs font-light tracking-wider">
              Sleeping è€å¸«èˆ‡ Gemini å…±ç·¨
            </div>
          </div>
          
          <div className="p-8 space-y-6">
            <div className="space-y-4">
              <div>
                <label className="text-sm font-bold text-gray-600 mb-1 flex items-center gap-2">
                  <User size={18} /> ç­ç´š
                </label>
                <input
                  type="text"
                  placeholder="ä¾‹å¦‚: 201"
                  className="w-full px-4 py-3 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:bg-white outline-none transition font-bold text-lg text-gray-700"
                  value={userInfo.classId}
                  onChange={(e) => setUserInfo({ ...userInfo, classId: e.target.value })}
                />
              </div>
              
              <div>
                <label className="text-sm font-bold text-gray-600 mb-1 flex items-center gap-2">
                  <Hash size={18} /> åº§è™Ÿ
                </label>
                <input
                  type="text"
                  placeholder="ä¾‹å¦‚: 0511"
                  className="w-full px-4 py-3 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:bg-white outline-none transition font-bold text-lg text-gray-700"
                  value={userInfo.seatId}
                  onChange={(e) => setUserInfo({ ...userInfo, seatId: e.target.value })}
                />
              </div>
            </div>

            <button
              onClick={handleStart}
              className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 rounded-2xl transition shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 transform hover:scale-[1.02] active:scale-95"
            >
              é–‹å§‹éŠæˆ² <Play fill="currentColor" />
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Screen: Levels
  if (screen === 'levels') {
    return (
      <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4">
        <div className="max-w-4xl w-full">
          <header className="mb-10 text-center">
            <h2 className="text-3xl font-black text-slate-800 mb-2">é¸æ“‡æŒ‘æˆ°æ¨¡å¼</h2>
            <div className="inline-block bg-white px-4 py-1 rounded-full shadow-sm text-slate-500 font-medium">
              {userInfo.classId}ç­ {userInfo.seatId}è™Ÿ
            </div>
          </header>

          <div className="grid md:grid-cols-2 gap-8">
            <button 
              onClick={initLevel1}
              className="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 border-b-8 border-blue-500 hover:-translate-y-2 relative overflow-hidden text-left"
            >
              <div className="absolute top-0 right-0 w-32 h-32 bg-blue-100 rounded-bl-full opacity-50 transition group-hover:scale-110"></div>
              <div className="relative z-10">
                <span className="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-4 inline-block">å®Œæ•´æŒ‘æˆ° (æ¨è–¦)</span>
                <h3 className="text-2xl font-bold text-slate-800 mb-2">å…¨èƒ½æŒ‘æˆ°è³½</h3>
                <p className="text-slate-500 mb-6">
                  å¾ç¬¬ä¸€é—œé–‹å§‹ï¼Œä¸€è·¯éé—œæ–¬å°‡ï¼<br/>
                  (ç¸½åˆ†100ï¼Œæ¯ç­”éŒ¯ä¸€æ¬¡æ‰£2åˆ†ï¼Œåˆ†æ•¸è·¨é—œå¡ç´¯ç©)
                </p>
                <div className="flex items-center gap-2 text-blue-600 font-bold">
                  é–‹å§‹æŒ‘æˆ° <ArrowRight size={20} />
                </div>
              </div>
            </button>

            <button 
              onClick={() => initLevel2(false)} // false = independent start
              className="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 border-b-8 border-purple-500 hover:-translate-y-2 relative overflow-hidden text-left opacity-80 hover:opacity-100"
            >
              <div className="absolute top-0 right-0 w-32 h-32 bg-purple-100 rounded-bl-full opacity-50 transition group-hover:scale-110"></div>
              <div className="relative z-10">
                <span className="bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-4 inline-block">å–®é—œç·´ç¿’</span>
                <h3 className="text-2xl font-bold text-slate-800 mb-2">åŒ–å­¸é…å°å¯¦é©—å®¤</h3>
                <p className="text-slate-500 mb-6">
                   åƒ…ç·´ç¿’ç¬¬äºŒé—œåŒ–å­¸å¼é…å°ã€‚<br/>
                   (åˆ†æ•¸ç¨ç«‹è¨ˆç®—ï¼Œä¸æœƒåˆ—å…¥ç¸½æŒ‘æˆ°æˆç¸¾)
                </p>
                <div className="flex items-center gap-2 text-purple-600 font-bold">
                  é–‹å§‹ç·´ç¿’ <ArrowRight size={20} />
                </div>
              </div>
            </button>
          </div>

          <div className="text-center mt-12">
            <button onClick={() => setScreen('welcome')} className="text-slate-400 hover:text-slate-600 font-medium">è¿”å›é¦–é </button>
          </div>
        </div>
      </div>
    );
  }

  // Summary Screens
  // Level 1 Summary: Intermediate screen, pass isIntermediate=true
  if (screen === 'summary-1') return <SummaryScreen title="ç¬¬ä¸€é—œï¼šç‰©è³ªåˆ†é¡" isIntermediate={true} />;
  // Level 2 Summary: Final screen
  if (screen === 'summary-2') return <SummaryScreen title="å…¨æŒ‘æˆ°" isIntermediate={false} />;

  // Screen: Game Level 1 (Classification)
  if (screen === 'game-level-1') {
    const isFinished = items.length === 0; // Though logic handles summary screen, keep safe check

    return (
      <div className="min-h-screen bg-slate-50 flex flex-col relative overflow-hidden">
        {feedback && <FeedbackToast />}
        
        {/* Header */}
        <div className="bg-white shadow-sm p-3 md:p-4 flex justify-between items-center z-10 shrink-0">
          <div className="font-bold text-slate-700 flex items-center gap-2">
            <button onClick={() => setScreen('levels')} className="hover:bg-slate-100 p-2 rounded-lg">
               <ArrowRight className="rotate-180" />
            </button>
            Level 1: ç‰©è³ªåˆ†é¡å·¥å» 
          </div>
          <div className="font-black text-xl md:text-2xl text-blue-600 flex items-center gap-2">
            <div className="text-sm font-normal text-slate-400">ç›®å‰å¾—åˆ†:</div>
            {score}
          </div>
        </div>

        {/* Game Area */}
        <div className="flex-1 p-2 md:p-4 flex flex-col max-w-6xl mx-auto w-full h-full">
          
          {/* Item Area */}
          <div className="shrink-0 min-h-[140px] md:min-h-[180px] mb-4 bg-slate-100 rounded-2xl border-2 border-slate-200 border-dashed relative flex items-center justify-center p-4">
             <div className="flex gap-4 overflow-x-auto pb-2 w-full justify-center">
                {items.slice(0, 5).map((item) => (
                  <div
                    key={item.id}
                    draggable
                    onDragStart={(e) => handleDragStart(e, item)}
                    onClick={() => handleItemClick(item)}
                    className={`bg-white rounded-xl shadow-md border-b-4 p-3 flex flex-col items-center justify-center cursor-grab active:cursor-grabbing transition-all transform hover:-translate-y-1 min-w-[100px] md:min-w-[120px] h-[120px] md:h-[140px]
                      ${draggedItem?.id === item.id ? 'border-blue-500 ring-4 ring-blue-200 scale-105 rotate-2' : 'border-slate-200'}
                    `}
                  >
                    <div className="mb-2 scale-90 md:scale-100 pointer-events-none">{item.icon}</div>
                    <div className="font-bold text-slate-800 text-sm md:text-base text-center leading-tight">{item.name}</div>
                    <div className="text-slate-400 text-xs font-mono mt-1">{item.formula}</div>
                  </div>
                ))}
              </div>
             <div className="absolute bottom-2 right-4 text-xs text-slate-400">å¾…åˆ†é¡: {items.length}</div>
          </div>

          {/* Bins Area */}
          <div className="flex-1 grid grid-cols-3 gap-2 md:gap-4 min-h-0">
             {bins.map((bin) => {
               const itemsInBin = droppedItems.filter(i => i.type === bin.id);
               return (
                 <div
                   key={bin.id}
                   onDragOver={handleDragOver}
                   onDrop={(e) => handleDropLevel1(e, bin.id)}
                   onClick={() => handleBinClick(bin.id)}
                   className={`${bin.color} rounded-2xl border-2 md:border-4 flex flex-col overflow-hidden transition-all relative ${draggedItem ? 'hover:brightness-95 cursor-pointer ring-2 ring-offset-2 ring-indigo-200' : ''}`}
                 >
                   <div className="bg-white/50 p-2 text-center border-b border-black/5">
                      <div className="text-lg md:text-2xl font-black opacity-80">{bin.label}</div>
                      <div className="text-xs opacity-60 font-medium">{itemsInBin.length} å€‹</div>
                   </div>
                   <div className="flex-1 p-2 content-start flex flex-wrap content-start gap-1 md:gap-2 overflow-y-auto">
                      {itemsInBin.map((item) => (
                        <div key={item.id} className="bg-white/80 rounded-md p-1 px-2 text-xs font-bold shadow-sm flex items-center gap-1 animate-in zoom-in duration-300">
                           <span className="w-2 h-2 rounded-full bg-current opacity-50"></span>
                           {item.name}
                        </div>
                      ))}
                      {draggedItem && (
                        <div className="w-full h-full absolute inset-0 bg-white/30 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity pointer-events-none">
                           <span className="text-4xl animate-bounce">â¬‡ï¸</span>
                        </div>
                      )}
                   </div>
                 </div>
               );
             })}
          </div>
        </div>
      </div>
    );
  }

  // Screen: Game Level 2 (Matching)
  if (screen === 'game-level-2') {
    const targets = matchingData; 

    return (
      <div className="min-h-screen bg-slate-50 flex flex-col">
         {feedback && <FeedbackToast />}

         <div className="bg-white shadow-sm p-4 flex justify-between items-center z-10">
          <div className="font-bold text-slate-700 flex items-center gap-2">
            <button onClick={() => setScreen('levels')} className="hover:bg-slate-100 p-2 rounded-lg">
               <ArrowRight className="rotate-180" />
            </button>
            Level 2: åŒ–å­¸é…å°å¯¦é©—å®¤
          </div>
          <div className="font-black text-xl md:text-2xl text-purple-600 flex items-center gap-2">
            <div className="text-sm font-normal text-slate-400">ç›®å‰å¾—åˆ†:</div>
            {score}
          </div>
        </div>

        <div className="flex-1 p-4 max-w-6xl mx-auto w-full flex flex-col md:flex-row gap-6">
            
            {/* Source Area */}
            <div className="flex-1 bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col overflow-hidden">
               <h3 className="text-lg font-bold text-slate-500 mb-4 flex items-center gap-2 shrink-0"><FlaskConical /> å¾…é…å°åŒ–å­¸å¼</h3>
               <div className="grid grid-cols-2 lg:grid-cols-3 gap-3 content-start overflow-y-auto pr-2">
                  {items.map(item => (
                    <div
                      key={item.id}
                      draggable
                      onDragStart={(e) => handleDragStart(e, item)}
                      onClick={() => handleItemClick(item)}
                      className={`p-4 rounded-xl border-2 bg-slate-50 text-center cursor-grab active:cursor-grabbing hover:bg-white hover:shadow-md transition
                         ${draggedItem?.id === item.id ? 'border-purple-500 bg-purple-50 scale-105 ring-2 ring-purple-200' : 'border-slate-200'}
                      `}
                    >
                       <div className="font-mono text-xl font-bold text-slate-700">{item.formula}</div>
                    </div>
                  ))}
               </div>
            </div>

            {/* Target Area */}
            <div className="flex-1 bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                <h3 className="text-lg font-bold text-slate-500 mb-4 flex items-center gap-2 shrink-0"><CheckCircle /> å®Œæˆå€ (ä¸­æ–‡/æ¨¡å‹)</h3>
                <div className="space-y-3 overflow-y-auto pr-2">
                   {targets.map(target => {
                     const isMatched = matchedPairs[target.id];
                     return (
                       <div
                         key={target.id}
                         onDragOver={handleDragOver}
                         onDrop={(e) => handleDropLevel2(e, target.id)}
                         onClick={() => handleSlotClick(target.id)}
                         className={`p-3 rounded-xl border-2 flex items-center justify-between transition-all
                            ${isMatched 
                               ? 'bg-green-50 border-green-200 opacity-80' 
                               : draggedItem 
                                  ? 'border-purple-300 bg-purple-50 cursor-pointer border-dashed' 
                                  : 'border-slate-100 bg-slate-50'}
                         `}
                       >
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm border border-slate-100">
                              {target.model}
                            </div>
                            <span className="font-bold text-slate-700">{target.name}</span>
                          </div>
                          <div className={`px-4 py-2 rounded-lg font-mono font-bold min-w-[80px] text-center transition-all
                             ${isMatched ? 'bg-green-500 text-white scale-110 shadow-sm' : 'bg-slate-200 text-slate-400'}
                          `}>
                             {isMatched ? isMatched.formula : '?'}
                          </div>
                       </div>
                     );
                   })}
                </div>
            </div>
        </div>
      </div>
    );
  }

  return <div>Loading...</div>;
}