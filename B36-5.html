<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç‰©è³ªåˆ†é¡èˆ‡é…å°å¤§æŒ‘æˆ°</title>
    
    <!-- 1. å¼•å…¥ Tailwind CSS (æ¨£å¼) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ React å’Œ ReactDOM (æ ¸å¿ƒ) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. å¼•å…¥ Babel (è®“ç€è¦½å™¨çœ‹ä¸æ‡‚çš„ JSX è®Šæˆçœ‹å¾—æ‡‚çš„ JS) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* ç¦æ­¢ iPad ä¸Šçš„æ–‡å­—é¸å–ï¼Œè®“æ“ä½œæ›´åƒ App */
        body {
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }
        /* éš±è—æ²è»¸ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        @keyframes pulse-red {
            0%, 100% { color: #ef4444; }
            50% { color: #b91c1c; }
        }
        .animate-pulse-red {
            animation: pulse-red 1s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-slate-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        /**
         * ============================================================================
         * ã€Google Apps Script è¨­å®šæ•™å­¸ï¼šåˆ†é—œå¡è©³ç´°ç´€éŒ„ã€‘
         * * è«‹å°‡ä»¥ä¸‹ç¨‹å¼ç¢¼è²¼å…¥æ‚¨çš„ Google Apps Script ç·¨è¼¯å™¨ä¸­ (å–ä»£åŸæœ‰çš„ myFunction)ï¼š
         * * function doPost(e) {
         * var ss = SpreadsheetApp.getActiveSpreadsheet();
         * var data = JSON.parse(e.postData.contents);
         * var className = data.classId || "æœªåˆ†é¡"; 
         * * // 1. å˜—è©¦ä¾ç…§ç­ç´šåç¨±å–å¾—åˆ†é 
         * var sheet = ss.getSheetByName(className);
         * * // 2. å¦‚æœåˆ†é ä¸å­˜åœ¨ï¼Œå°±è‡ªå‹•å»ºç«‹æ–°åˆ†é ä¸¦åŠ å…¥æ¨™é¡Œ
         * if (!sheet) {
         * sheet = ss.insertSheet(className);
         * // è¨­å®šæ¨™é¡Œåˆ—ï¼šæ™‚é–“ã€ç­ç´šã€åº§è™Ÿã€ç¸½åˆ†ã€ç¬¬ä¸€é—œéŒ¯èª¤ã€ç¬¬äºŒé—œéŒ¯èª¤
         * sheet.appendRow(["æ™‚é–“", "ç­ç´š", "åº§è™Ÿ", "ç¸½åˆ†", "ç¬¬ä¸€é—œéŒ¯èª¤å›é¥‹", "ç¬¬äºŒé—œéŒ¯èª¤å›é¥‹"]); 
         * }
         * * // 3. å¯«å…¥è³‡æ–™
         * sheet.appendRow([
         * data.timestamp, 
         * data.classId, 
         * data.seatId, 
         * data.score, 
         * data.mistakesLevel1, // ç¬¬ä¸€é—œéŒ¯èª¤è©³æƒ…
         * data.mistakesLevel2  // ç¬¬äºŒé—œéŒ¯èª¤è©³æƒ…
         * ]);
         * * return ContentService.createTextOutput("Success");
         * }
         * * ============================================================================
         * éƒ¨ç½²æ­¥é©Ÿï¼š
         * 1. è²¼ä¸Šç¨‹å¼ç¢¼å¾Œå­˜æª”ã€‚
         * 2. é»é¸å³ä¸Šè§’ã€Œéƒ¨ç½²ã€->ã€Œæ–°å¢éƒ¨ç½²ã€ã€‚
         * 3. é¡å‹é¸æ“‡ã€Œç¶²é æ‡‰ç”¨ç¨‹å¼ã€ã€‚
         * 4. æè¿°éš¨æ„ï¼ŒåŸ·è¡Œèº«åˆ†é¸ã€Œæˆ‘ (Me)ã€ï¼Œèª°å¯ä»¥å­˜å–é¸ã€Œæ‰€æœ‰äºº (Anyone)ã€ã€‚
         * 5. é»é¸ã€Œéƒ¨ç½²ã€ï¼Œè¤‡è£½ç”¢ç”Ÿçš„ç¶²å€ï¼Œå¡«å…¥ä¸‹æ–¹çš„ GOOGLE_SCRIPT_URL ä¸­ã€‚
         * ============================================================================
         */

        // --- è¨­å®šå€ ---
        // è«‹å°‡éƒ¨ç½²å¥½çš„ Google Apps Script URL å¡«å…¥ä¸‹æ–¹å¼•è™Ÿä¸­
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzgAKBM7QhgAvTnndDO0-jLDiJiwTqyLAErzQIpkxONRlVTKPiwViWc2X6lh_-TNasykA/exec"; 

        // --- å…§å»ºåœ–ç¤ºå…ƒä»¶ (å–ä»£ lucide-react) ---
        const IconBase = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Play: (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconBase>,
            CheckCircle: (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></IconBase>,
            XCircle: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></IconBase>,
            Award: (props) => <IconBase {...props}><circle cx="12" cy="8" r="7"></circle><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline></IconBase>,
            ArrowRight: (props) => <IconBase {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></IconBase>,
            User: (props) => <IconBase {...props}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></IconBase>,
            Hash: (props) => <IconBase {...props}><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></IconBase>,
            FlaskConical: (props) => <IconBase {...props}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"></path><line x1="8.5" y1="2" x2="15.5" y2="2"></line><path d="M8.5 14h7"></path></IconBase>,
            RefreshCw: (props) => <IconBase {...props}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconBase>,
            Beaker: (props) => <IconBase {...props}><path d="M4.5 3h15"></path><path d="M6 3v16a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V3"></path><path d="M6 14h12"></path></IconBase>,
            Save: (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconBase>,
            AlertTriangle: (props) => <IconBase {...props}><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></IconBase>,
            FastForward: (props) => <IconBase {...props}><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></IconBase>,
            Clock: (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></IconBase>
        };

        // --- æ¨¡å‹å…ƒä»¶ ---
        const AtomModel = ({ color = "#ef4444", label }) => (
            <svg viewBox="0 0 50 50" className="w-10 h-10 md:w-12 md:h-12 inline-block drop-shadow-md">
                <circle cx="25" cy="25" r="12" fill={color} stroke="#333" strokeWidth="1.5" />
                <circle cx="20" cy="20" r="3" fill="white" fillOpacity="0.3" />
                {label && <text x="25" y="25" textAnchor="middle" dy=".3em" fontSize="10" fill="white" fontWeight="bold">{label}</text>}
            </svg>
        );

        const DiatomicModel = ({ color = "#3b82f6" }) => (
            <svg viewBox="0 0 60 40" className="w-12 h-8 md:w-14 md:h-10 inline-block drop-shadow-md">
                <g>
                <circle cx="20" cy="20" r="10" fill={color} stroke="#333" strokeWidth="1.5" />
                <circle cx="40" cy="20" r="10" fill={color} stroke="#333" strokeWidth="1.5" />
                </g>
            </svg>
        );

        const TriatomicModel = ({ color = "#ef4444" }) => (
            <svg viewBox="0 0 60 50" className="w-12 h-10 md:w-14 md:h-12 inline-block drop-shadow-md">
                <g transform="translate(5,5)">
                <circle cx="10" cy="30" r="9" fill={color} stroke="#333" strokeWidth="1.5" />
                <circle cx="25" cy="10" r="9" fill={color} stroke="#333" strokeWidth="1.5" />
                <circle cx="40" cy="30" r="9" fill={color} stroke="#333" strokeWidth="1.5" />
                </g>
            </svg>
        );

        const WaterModel = () => (
            <svg viewBox="0 0 50 50" className="w-10 h-10 md:w-12 md:h-12 inline-block drop-shadow-md">
                <g transform="translate(5,5)">
                <circle cx="10" cy="12" r="7" fill="#cbd5e1" stroke="#333" strokeWidth="1.5" />
                <circle cx="38" cy="12" r="7" fill="#cbd5e1" stroke="#333" strokeWidth="1.5" />
                <circle cx="24" cy="28" r="12" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
                </g>
            </svg>
        );

        const LinearMolecule = ({ type = 'tri' }) => (
            <svg viewBox="0 0 70 40" className="w-14 h-8 md:w-16 md:h-10 inline-block drop-shadow-md">
                <g transform="translate(5,0)">
                {type === 'tri' ? (
                    <>
                    <circle cx="10" cy="20" r="9" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
                    <circle cx="30" cy="20" r="10" fill="#333" stroke="#333" strokeWidth="1.5" />
                    <circle cx="50" cy="20" r="9" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
                    </>
                ) : (
                    <>
                    <circle cx="20" cy="20" r="10" fill="#333" stroke="#333" strokeWidth="1.5" />
                    <circle cx="40" cy="20" r="9" fill="#ef4444" stroke="#333" strokeWidth="1.5" />
                    </>
                )}
                </g>
            </svg>
        );

        const MixtureModel = ({ color = "#ef4444" }) => (
            <svg viewBox="0 0 60 60" className="w-12 h-12 md:w-14 md:h-14 inline-block bg-white/50 rounded-full border border-dashed border-gray-400 p-1">
                <circle cx="15" cy="15" r="5" fill={color} />
                <circle cx="45" cy="45" r="5" fill={color} />
                <circle cx="45" cy="15" r="6" fill="#3b82f6" />
                <circle cx="15" cy="45" r="4" fill="#22c55e" />
            </svg>
        );

        // --- è³‡æ–™ ---
        const classificationData = [
            { id: 'c1', name: 'æ°§æ°£', formula: 'Oâ‚‚', type: 'element', icon: <DiatomicModel color="#3b82f6" /> },
            { id: 'c4', name: 'éŠ…ç·š', formula: 'Cu', type: 'element', icon: <AtomModel color="#d97706" /> },
            { id: 'c7', name: 'æ°¦æ°£', formula: 'He', type: 'element', icon: <AtomModel color="#a855f7" /> },
            { id: 'c9', name: 'éµé‡˜', formula: 'Fe', type: 'element', icon: <AtomModel color="#64748b" /> },
            { id: 'c10', name: 'é»ƒé‡‘', formula: 'Au', type: 'element', icon: <AtomModel color="#fbbf24" /> },
            { id: 'c13', name: 'é‘½çŸ³', formula: 'C', type: 'element', icon: <AtomModel color="#bae6fd" /> },
            { id: 'c18', name: 'æ°¬æ°£', formula: 'Ar', type: 'element', icon: <AtomModel color="#10b981" /> },
            { id: 'c19', name: 'è‡­æ°§', formula: 'Oâ‚ƒ', type: 'element', icon: <TriatomicModel color="#3b82f6" /> },
            { id: 'c2', name: 'æ°´', formula: 'Hâ‚‚O', type: 'compound', icon: <WaterModel /> },
            { id: 'c5', name: 'äºŒæ°§åŒ–ç¢³', formula: 'COâ‚‚', type: 'compound', icon: <LinearMolecule type="tri" /> },
            { id: 'c8', name: 'é£Ÿé¹½(æ°¯åŒ–éˆ‰)', formula: 'NaCl', type: 'compound', icon: <div className="flex gap-1 items-center"><AtomModel color="#22c55e" label="Cl" /><AtomModel color="#64748b" label="Na" /></div> },
            { id: 'c11', name: 'ç´”é…’ç²¾', formula: 'Câ‚‚Hâ‚…OH', type: 'compound', icon: <Icons.FlaskConical className="w-10 h-10 text-purple-400" /> },
            { id: 'c14', name: 'ä¹¾å†°', formula: 'COâ‚‚', type: 'compound', icon: <div className="relative"><LinearMolecule type="tri" /><span className="absolute -top-2 -right-2 text-xs">ğŸ’¨</span></div> },
            { id: 'c15', name: 'æ°¨æ°£', formula: 'NHâ‚ƒ', type: 'compound', icon: <AtomModel color="#fcd34d" label="N" /> },
            { id: 'c20', name: 'ä¸€æ°§åŒ–ç¢³', formula: 'CO', type: 'compound', icon: <LinearMolecule type="di" /> },
            { id: 'c3', name: 'ç©ºæ°£', formula: 'Air', type: 'mixture', icon: <MixtureModel /> },
            { id: 'c6', name: 'ç³–æ°´', formula: 'Sugar Water', type: 'mixture', icon: <Icons.Beaker className="w-10 h-10 text-orange-400" /> },
            { id: 'c12', name: 'é¹½é…¸', formula: 'HCl(aq)', type: 'mixture', icon: <Icons.FlaskConical className="w-10 h-10 text-yellow-500" /> },
            { id: 'c16', name: 'é›™æ°§æ°´', formula: 'Hâ‚‚Oâ‚‚(aq)', type: 'mixture', icon: <Icons.FlaskConical className="w-10 h-10 text-blue-300" /> },
            { id: 'c17', name: 'å¢¨æ°´', formula: 'Ink', type: 'mixture', icon: <div className="w-10 h-10 bg-black rounded-full border-2 border-gray-400 opacity-80" /> },
        ];

        const matchingData = [
            { id: 'm1', formula: 'Hâ‚‚O', name: 'æ°´', model: <WaterModel /> },
            { id: 'm2', formula: 'COâ‚‚', name: 'äºŒæ°§åŒ–ç¢³', model: <LinearMolecule type="tri" /> },
            { id: 'm3', formula: 'Oâ‚‚', name: 'æ°§æ°£', model: <DiatomicModel color="#3b82f6" /> },
            { id: 'm4', formula: 'NaCl', name: 'æ°¯åŒ–éˆ‰', model: <div className="flex items-center justify-center scale-75"><AtomModel color="#64748b" /><AtomModel color="#22c55e" /></div> },
            { id: 'm5', formula: 'Câ‚†Hâ‚â‚‚Oâ‚†', name: 'è‘¡è„ç³–', model: <span className="text-2xl">ğŸ¬</span> },
            { id: 'm6', formula: 'Mg', name: 'é‚', model: <AtomModel color="#94a3b8" label="Mg" /> },
            { id: 'm7', formula: 'Ar', name: 'æ°¬æ°£', model: <AtomModel color="#10b981" label="Ar" /> },
            { id: 'm8', formula: 'Oâ‚ƒ', name: 'è‡­æ°§', model: <TriatomicModel color="#3b82f6" /> },
            { id: 'm9', formula: 'CO', name: 'ä¸€æ°§åŒ–ç¢³', model: <LinearMolecule type="di" /> },
            { id: 'm10', formula: 'Nâ‚‚', name: 'æ°®æ°£', model: <DiatomicModel color="#94a3b8" /> },
            { id: 'm11', formula: 'Hâ‚‚', name: 'æ°«æ°£', model: <DiatomicModel color="#cbd5e1" /> },
            { id: 'm12', formula: 'Fe', name: 'éµ', model: <AtomModel color="#475569" label="Fe" /> },
            { id: 'm13', formula: 'Cu', name: 'éŠ…', model: <AtomModel color="#d97706" label="Cu" /> },
            { id: 'm14', formula: 'Au', name: 'é‡‘', model: <AtomModel color="#fbbf24" label="Au" /> },
            { id: 'm15', formula: 'He', name: 'æ°¦æ°£', model: <AtomModel color="#a855f7" label="He" /> },
            { id: 'm16', formula: 'Clâ‚‚', name: 'æ°¯æ°£', model: <DiatomicModel color="#22c55e" /> },
        ];

        function MatterQuizApp() {
            const [screen, setScreen] = useState('welcome');
            const [userInfo, setUserInfo] = useState({ classId: '', seatId: '' });
            const [score, setScore] = useState(100);
            const [mistakeHistory, setMistakeHistory] = useState([]);
            const [submissionStatus, setSubmissionStatus] = useState('idle');
            const [isCombinedSession, setIsCombinedSession] = useState(false);
            const [timeLeft, setTimeLeft] = useState(0); // å‰©é¤˜æ™‚é–“ (ç§’)
            
            const [draggedItem, setDraggedItem] = useState(null);
            const [items, setItems] = useState([]);
            const [droppedItems, setDroppedItems] = useState([]); 
            const [matchedPairs, setMatchedPairs] = useState({});
            const [feedback, setFeedback] = useState(null);

            const bins = [
                { id: 'element', label: 'å…ƒç´ ', color: 'bg-blue-50 border-blue-500 text-blue-800' },
                { id: 'compound', label: 'åŒ–åˆç‰©', color: 'bg-green-50 border-green-500 text-green-800' },
                { id: 'mixture', label: 'æ··åˆç‰©', color: 'bg-orange-50 border-orange-500 text-orange-800' },
            ];

            // è¨ˆæ™‚å™¨æ•ˆæœ
            useEffect(() => {
                let timer;
                if ((screen === 'game-level-1' || screen === 'game-level-2') && timeLeft > 0) {
                    timer = setInterval(() => {
                        setTimeLeft((prev) => prev - 1);
                    }, 1000);
                } else if (timeLeft === 0 && (screen === 'game-level-1' || screen === 'game-level-2')) {
                    // æ™‚é–“åˆ°ï¼Œå¼·åˆ¶çµç®—
                    if (screen === 'game-level-1') setScreen('summary-1');
                    if (screen === 'game-level-2') setScreen('summary-2');
                }
                return () => clearInterval(timer);
            }, [screen, timeLeft]);

            // æ ¼å¼åŒ–æ™‚é–“ mm:ss
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            const handleStart = () => {
                if (userInfo.classId && userInfo.seatId) {
                    setScreen('levels');
                } else {
                    alert("è«‹è¼¸å…¥ç­ç´šèˆ‡åº§è™Ÿï¼");
                }
            };

            const initLevel1 = () => {
                setItems([...classificationData].sort(() => Math.random() - 0.5));
                setDroppedItems([]);
                setScore(100);
                setMistakeHistory([]);
                setIsCombinedSession(true);
                setTimeLeft(90); // ç¬¬ä¸€é—œ 90 ç§’
                setSubmissionStatus('idle');
                setScreen('game-level-1');
                setFeedback(null);
            };

            const initLevel2 = (isContinuation = false) => {
                setItems([...matchingData].sort(() => Math.random() - 0.5));
                setMatchedPairs({});
                
                if (!isContinuation) {
                    setScore(100);
                    setMistakeHistory([]);
                    setIsCombinedSession(false);
                }
                
                setTimeLeft(150); // ç¬¬äºŒé—œ 2 åˆ† 30 ç§’ = 150 ç§’
                setSubmissionStatus('idle');
                setScreen('game-level-2');
                setFeedback(null);
            };

            const submitScore = async () => {
                if (!GOOGLE_SCRIPT_URL) {
                    alert("ç›®å‰å°šæœªè¨­å®š Google Apps Script ä¸Šå‚³ç¶²å€ã€‚è«‹è€å¸«è¨­å®šå¾Œå†è©¦ã€‚");
                    return;
                }

                setSubmissionStatus('submitting');
                
                // æ•´ç†éŒ¯èª¤å›é¥‹
                const l1Mistakes = mistakeHistory.filter(m => m.level === 1).map(m => `${m.item}(èª¤:${m.wrong})`).join(", ") || "ç„¡";
                const l2Mistakes = mistakeHistory.filter(m => m.level === 2).map(m => `${m.item}(èª¤:${m.wrong})`).join(", ") || "ç„¡";

                const data = {
                    timestamp: new Date().toLocaleString(),
                    classId: userInfo.classId,
                    seatId: userInfo.seatId,
                    score: score,
                    mistakesLevel1: l1Mistakes,
                    mistakesLevel2: l2Mistakes
                };

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    setSubmissionStatus('success');
                } catch (error) {
                    console.error("Submission error", error);
                    setSubmissionStatus('error');
                }
            };

            // iPad é»æ“Šé‚è¼¯ (å–ä»£æ‹–æ›³)
            const handleItemClick = (item) => {
                if (draggedItem && draggedItem.id === item.id) {
                    setDraggedItem(null); 
                } else {
                    setDraggedItem(item); 
                }
            };

            // Level 1: é»æ“Šç®±å­ (æ”¾ç½®)
            const handleBinClick = (binType) => {
                if (draggedItem) {
                    if (draggedItem.type === binType) {
                        setDroppedItems(prev => [...prev, draggedItem]);
                        setItems(prev => prev.filter(i => i.id !== draggedItem.id));
                        setFeedback({ type: 'success', msg: 'ç­”å°äº†ï¼' });
                        setTimeout(() => setFeedback(null), 800);
                        if (items.length <= 1) setTimeout(() => setScreen('summary-1'), 1500);
                    } else {
                        setScore(prev => Math.max(0, prev - 2));
                        const binLabel = bins.find(b => b.id === binType).label;
                        const correctLabel = bins.find(b => b.id === draggedItem.type).label;
                        setMistakeHistory(prev => [...prev, { level: 1, item: draggedItem.name, wrong: binLabel, correct: correctLabel }]);
                        setFeedback({ type: 'error', msg: 'åˆ†é¡éŒ¯èª¤ï¼Œæ‰£ 2 åˆ†ï¼' });
                        setTimeout(() => setFeedback(null), 1500);
                    }
                    setDraggedItem(null);
                }
            };

            // Level 2: é»æ“Šé…å°æ¡† (æ”¾ç½®)
            const handleSlotClick = (targetId) => {
                if (draggedItem) {
                    if (draggedItem.id === targetId) {
                        setMatchedPairs(prev => ({ ...prev, [targetId]: draggedItem }));
                        setItems(prev => prev.filter(i => i.id !== draggedItem.id));
                        setFeedback({ type: 'success', msg: 'é…å°æˆåŠŸï¼' });
                        setTimeout(() => setFeedback(null), 800);
                        if (items.length <= 1) setTimeout(() => setScreen('summary-2'), 1500);
                    } else {
                        setScore(prev => Math.max(0, prev - 2));
                        const targetName = matchingData.find(m => m.id === targetId).name;
                        const correctTarget = matchingData.find(m => m.id === draggedItem.id).name;
                        setMistakeHistory(prev => [...prev, { level: 2, item: draggedItem.formula, wrong: `é…å°çµ¦ ${targetName}`, correct: correctTarget }]);
                        setFeedback({ type: 'error', msg: 'é…å°éŒ¯èª¤ï¼Œæ‰£ 2 åˆ†ï¼' });
                        setTimeout(() => setFeedback(null), 1500);
                    }
                    setDraggedItem(null);
                }
            }

            // å…ƒä»¶æ¸²æŸ“
            const FeedbackToast = () => (
                <div className={`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-full shadow-lg font-bold text-lg transition-all duration-300 z-50 flex items-center gap-2 ${
                    feedback?.type === 'success' ? 'bg-green-500 text-white scale-110' : 
                    feedback?.type === 'error' ? 'bg-red-500 text-white animate-pulse' : 'opacity-0'
                }`}>
                    {feedback?.type === 'success' ? <Icons.CheckCircle /> : <Icons.XCircle />}
                    {feedback?.msg}
                </div>
            );

            const SummaryScreen = ({ title, isIntermediate = false }) => (
                <div className="min-h-screen bg-slate-100 flex items-center justify-center p-4">
                    <div className="bg-white max-w-2xl w-full rounded-2xl shadow-xl overflow-hidden p-8">
                        <div className="text-center mb-8">
                            <div className="mx-auto text-yellow-500 mb-4 flex justify-center"><Icons.Award className="w-16 h-16"/></div>
                            <h2 className="text-3xl font-black text-slate-800">{title} å®Œæˆï¼</h2>
                            <div className="mt-4 text-6xl font-black text-indigo-600 tracking-tight">
                                {score} <span className="text-2xl text-slate-400">åˆ†</span>
                            </div>
                            {isIntermediate && (
                                <p className="text-slate-500 mt-2 font-bold">ç›®å‰åˆ†æ•¸ (å°‡å¸¶å…¥ä¸‹ä¸€é—œ)</p>
                            )}
                        </div>

                        <div className="mb-8">
                            <h3 className="text-lg font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <Icons.AlertTriangle className="text-orange-500 w-5 h-5" />
                                {isIntermediate ? "æœ¬é—œå­¸ç¿’å›é¥‹" : "å®Œæ•´å­¸ç¿’å›é¥‹"}
                            </h3>
                            {mistakeHistory.length === 0 ? (
                                <div className="bg-green-50 text-green-700 p-4 rounded-xl text-center font-bold">
                                    å¤ªæ£’äº†ï¼æŒ‘æˆ°å®Œå…¨æ­£ç¢ºï¼Œæ²’æœ‰å¤±èª¤ï¼
                                </div>
                            ) : (
                                <div className="bg-slate-50 rounded-xl border border-slate-200 overflow-hidden max-h-60 overflow-y-auto">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-100 text-slate-500 sticky top-0">
                                            <tr>
                                                <th className="p-3">é¡Œç›®</th>
                                                <th className="p-3">ä½ çš„å›ç­”</th>
                                                <th className="p-3">æ­£ç¢ºç­”æ¡ˆ</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {mistakeHistory.map((m, idx) => (
                                                <tr key={idx} className="border-t border-slate-200">
                                                    <td className="p-3 font-bold text-slate-700">{m.item}</td>
                                                    <td className="p-3 text-red-500">{m.wrong}</td>
                                                    <td className="p-3 text-green-600 font-bold">{m.correct}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                    <div className="p-3 bg-red-50 text-red-600 text-xs text-center border-t border-red-100">
                                        ç›®å‰å…±ç­”éŒ¯ {mistakeHistory.length} æ¬¡ï¼Œæ‰£ {mistakeHistory.length * 2} åˆ†
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            {isIntermediate ? (
                                <>
                                    <button 
                                        onClick={() => initLevel2(true)}
                                        className="col-span-2 bg-indigo-600 hover:bg-indigo-700 text-white py-4 rounded-xl font-bold text-xl shadow-lg flex items-center justify-center gap-2 animate-pulse"
                                    >
                                        <Icons.FastForward fill="currentColor" /> æŒ‘æˆ°ç¬¬äºŒé—œ (Level 2)
                                    </button>
                                </>
                            ) : (
                                <>
                                    <button 
                                        onClick={submitScore}
                                        disabled={submissionStatus === 'success' || submissionStatus === 'submitting'}
                                        className={`flex items-center justify-center gap-2 py-3 rounded-xl font-bold text-white transition
                                            ${submissionStatus === 'success' ? 'bg-green-500 cursor-default' : 
                                            submissionStatus === 'submitting' ? 'bg-gray-400 cursor-wait' : 'bg-indigo-600 hover:bg-indigo-700'}
                                        `}
                                    >
                                        {submissionStatus === 'idle' && <><Icons.Save className="w-5 h-5" /> ä¸Šå‚³ç¸½æˆç¸¾</>}
                                        {submissionStatus === 'submitting' && <Icons.RefreshCw className="animate-spin w-5 h-5" />}
                                        {submissionStatus === 'success' && <><Icons.CheckCircle className="w-5 h-5" /> ä¸Šå‚³æˆåŠŸ</>}
                                        {submissionStatus === 'error' && <><Icons.XCircle className="w-5 h-5" /> ä¸Šå‚³å¤±æ•—(è«‹é‡è©¦)</>}
                                    </button>
                                    
                                    <button 
                                        onClick={() => setScreen('levels')}
                                        className="border-2 border-slate-200 hover:bg-slate-50 text-slate-600 py-3 rounded-xl font-bold transition"
                                    >
                                        å›åˆ°é¸å–®
                                    </button>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            );

            if (screen === 'welcome') {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-4">
                        <div className="bg-white/95 backdrop-blur-sm max-w-md w-full rounded-3xl shadow-2xl overflow-hidden border-4 border-white/50">
                            <div className="bg-slate-800 p-8 text-center text-white relative overflow-hidden">
                                <h1 className="text-4xl font-black mb-2 tracking-tight relative z-10">ç†åŒ–å¤§æŒ‘æˆ°</h1>
                                <p className="text-indigo-200 font-medium relative z-10">ç‰©è³ªåˆ†é¡ & åŒ–å­¸é…å°</p>
                                <div className="mt-4 inline-block bg-white/20 px-3 py-1 rounded-full text-xs font-light tracking-wider">
                                    Sleeping è€å¸«èˆ‡ Gemini å…±ç·¨
                                </div>
                                <div className="mt-6 text-indigo-100 text-sm space-y-1">
                                    <p>ğŸ“± å»ºè­° iPad ä½¿ç”¨ <b>æ©«å¼ (Landscape)</b> æ“ä½œ</p>
                                    <p>ğŸ’¯ æ»¿åˆ† 100 åˆ†ï¼Œæ¯ç­”éŒ¯ä¸€æ¬¡æ‰£ 2 åˆ†</p>
                                </div>
                            </div>
                            
                            <div className="p-8 space-y-6">
                                <div className="space-y-4">
                                    <div>
                                        <label className="text-sm font-bold text-gray-600 mb-1 flex items-center gap-2">
                                            <Icons.User className="w-4 h-4" /> ç­ç´š
                                        </label>
                                        <input
                                            type="text"
                                            placeholder="ä¾‹å¦‚: 201"
                                            className="w-full px-4 py-3 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:bg-white outline-none transition font-bold text-lg text-gray-700"
                                            value={userInfo.classId}
                                            onChange={(e) => setUserInfo({ ...userInfo, classId: e.target.value })}
                                        />
                                    </div>
                                    
                                    <div>
                                        <label className="text-sm font-bold text-gray-600 mb-1 flex items-center gap-2">
                                            <Icons.Hash className="w-4 h-4" /> åº§è™Ÿ
                                        </label>
                                        <input
                                            type="text"
                                            placeholder="ä¾‹å¦‚: 0511"
                                            className="w-full px-4 py-3 bg-gray-50 rounded-xl border-2 border-gray-200 focus:border-indigo-500 focus:bg-white outline-none transition font-bold text-lg text-gray-700"
                                            value={userInfo.seatId}
                                            onChange={(e) => setUserInfo({ ...userInfo, seatId: e.target.value })}
                                        />
                                    </div>
                                </div>

                                <button
                                    onClick={handleStart}
                                    className="w-full bg-indigo-600 hover:bg-indigo-700 text-white text-xl font-bold py-4 rounded-2xl transition shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 transform hover:scale-[1.02] active:scale-95"
                                >
                                    é–‹å§‹éŠæˆ² <Icons.Play fill="currentColor" />
                                </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'levels') {
                return (
                    <div className="min-h-screen bg-slate-100 flex flex-col items-center justify-center p-4">
                        <div className="max-w-4xl w-full">
                            <header className="mb-10 text-center">
                                <h2 className="text-3xl font-black text-slate-800 mb-2">é¸æ“‡æŒ‘æˆ°æ¨¡å¼</h2>
                                <div className="inline-block bg-white px-4 py-1 rounded-full shadow-sm text-slate-500 font-medium">
                                    {userInfo.classId}ç­ {userInfo.seatId}è™Ÿ
                                </div>
                            </header>

                            <div className="grid md:grid-cols-2 gap-8">
                                <button 
                                    onClick={initLevel1}
                                    className="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 border-b-8 border-blue-500 hover:-translate-y-2 relative overflow-hidden text-left"
                                >
                                    <div className="relative z-10">
                                        <span className="bg-blue-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-4 inline-block">å®Œæ•´æŒ‘æˆ° (æ¨è–¦)</span>
                                        <h3 className="text-2xl font-bold text-slate-800 mb-2">å…¨èƒ½æŒ‘æˆ°è³½</h3>
                                        <p className="text-slate-500 mb-6">
                                            å¾ç¬¬ä¸€é—œé–‹å§‹ï¼Œä¸€è·¯éé—œæ–¬å°‡ï¼<br/>
                                            (ç¸½åˆ†100ï¼Œæ¯ç­”éŒ¯ä¸€æ¬¡æ‰£2åˆ†ï¼Œåˆ†æ•¸è·¨é—œå¡ç´¯ç©)
                                        </p>
                                        <div className="flex items-center gap-2 text-blue-600 font-bold">
                                            é–‹å§‹æŒ‘æˆ° <Icons.ArrowRight className="w-5 h-5" />
                                        </div>
                                    </div>
                                </button>

                                <button 
                                    onClick={() => initLevel2(false)}
                                    className="group bg-white p-8 rounded-3xl shadow-xl hover:shadow-2xl transition-all duration-300 border-b-8 border-purple-500 hover:-translate-y-2 relative overflow-hidden text-left opacity-80 hover:opacity-100"
                                >
                                    <div className="relative z-10">
                                        <span className="bg-purple-500 text-white text-xs font-bold px-3 py-1 rounded-full mb-4 inline-block">å–®é—œç·´ç¿’</span>
                                        <h3 className="text-2xl font-bold text-slate-800 mb-2">åŒ–å­¸é…å°å¯¦é©—å®¤</h3>
                                        <p className="text-slate-500 mb-6">
                                            åƒ…ç·´ç¿’ç¬¬äºŒé—œåŒ–å­¸å¼é…å°ã€‚<br/>
                                            (åˆ†æ•¸ç¨ç«‹è¨ˆç®—ï¼Œä¸æœƒåˆ—å…¥ç¸½æŒ‘æˆ°æˆç¸¾)
                                        </p>
                                        <div className="flex items-center gap-2 text-purple-600 font-bold">
                                            é–‹å§‹ç·´ç¿’ <Icons.ArrowRight className="w-5 h-5" />
                                        </div>
                                    </div>
                                </button>
                            </div>

                            <div className="text-center mt-12">
                                <button onClick={() => setScreen('welcome')} className="text-slate-400 hover:text-slate-600 font-medium">è¿”å›é¦–é </button>
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'summary-1') return <SummaryScreen title="ç¬¬ä¸€é—œï¼šç‰©è³ªåˆ†é¡" isIntermediate={true} />;
            if (screen === 'summary-2') return <SummaryScreen title="å…¨æŒ‘æˆ°" isIntermediate={false} />;

            if (screen === 'game-level-1') {
                const isFinished = items.length === 0;

                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col relative overflow-hidden">
                        {feedback && <FeedbackToast />}
                        
                        <div className="bg-white shadow-sm p-3 md:p-4 flex justify-between items-center z-10 shrink-0">
                            <div className="font-bold text-slate-700 flex items-center gap-2">
                                <button onClick={() => setScreen('levels')} className="hover:bg-slate-100 p-2 rounded-lg">
                                    <Icons.ArrowRight className="rotate-180 w-5 h-5" />
                                </button>
                                Level 1: ç‰©è³ªåˆ†é¡å·¥å» 
                            </div>
                            <div className="flex items-center gap-4">
                                <div className={`flex items-center gap-1 font-mono text-xl font-bold ${timeLeft < 10 ? 'text-red-500 animate-pulse-red' : 'text-slate-600'}`}>
                                    <Icons.Clock className="w-5 h-5" />
                                    {formatTime(timeLeft)}
                                </div>
                                <div className="font-black text-xl md:text-2xl text-blue-600 flex items-center gap-2">
                                    <div className="text-sm font-normal text-slate-400">ç›®å‰å¾—åˆ†:</div>
                                    {score}
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 p-2 md:p-4 flex flex-col max-w-6xl mx-auto w-full h-full">
                            <div className="shrink-0 min-h-[140px] md:min-h-[180px] mb-4 bg-slate-100 rounded-2xl border-2 border-slate-200 border-dashed relative flex items-center justify-center p-4">
                                <div className="flex gap-4 overflow-x-auto pb-2 w-full justify-center no-scrollbar">
                                    {items.slice(0, 5).map((item) => (
                                        <div
                                            key={item.id}
                                            onClick={() => handleItemClick(item)}
                                            className={`bg-white rounded-xl shadow-md border-b-4 p-3 flex flex-col items-center justify-center cursor-pointer transition-all transform hover:-translate-y-1 min-w-[100px] md:min-w-[120px] h-[120px] md:h-[140px] select-none
                                            ${draggedItem?.id === item.id ? 'border-blue-500 ring-4 ring-blue-200 scale-105 rotate-2' : 'border-slate-200'}
                                            `}
                                        >
                                            <div className="mb-2 scale-90 md:scale-100 pointer-events-none">{item.icon}</div>
                                            <div className="font-bold text-slate-800 text-sm md:text-base text-center leading-tight">{item.name}</div>
                                            <div className="text-slate-400 text-xs font-mono mt-1">{item.formula}</div>
                                        </div>
                                    ))}
                                </div>
                                <div className="absolute bottom-2 right-4 text-xs text-slate-400">å¾…åˆ†é¡: {items.length}</div>
                            </div>

                            <div className="flex-1 grid grid-cols-3 gap-2 md:gap-4 min-h-0">
                                {bins.map((bin) => {
                                    const itemsInBin = droppedItems.filter(i => i.type === bin.id);
                                    return (
                                        <div
                                            key={bin.id}
                                            onClick={() => handleBinClick(bin.id)}
                                            className={`${bin.color} rounded-2xl border-2 md:border-4 flex flex-col overflow-hidden transition-all relative ${draggedItem ? 'cursor-pointer ring-2 ring-offset-2 ring-indigo-200 brightness-95' : ''}`}
                                        >
                                            <div className="bg-white/50 p-2 text-center border-b border-black/5">
                                                <div className="text-lg md:text-2xl font-black opacity-80">{bin.label}</div>
                                                <div className="text-xs opacity-60 font-medium">{itemsInBin.length} å€‹</div>
                                            </div>
                                            <div className="flex-1 p-2 content-start flex flex-wrap content-start gap-1 md:gap-2 overflow-y-auto no-scrollbar">
                                                {itemsInBin.map((item) => (
                                                    <div key={item.id} className="bg-white/80 rounded-md p-1 px-2 text-xs font-bold shadow-sm flex items-center gap-1 animate-in zoom-in duration-300">
                                                        <span className="w-2 h-2 rounded-full bg-current opacity-50"></span>
                                                        {item.name}
                                                    </div>
                                                ))}
                                                {draggedItem && (
                                                    <div className="w-full h-full absolute inset-0 bg-white/30 flex items-center justify-center opacity-0 hover:opacity-100 transition-opacity pointer-events-none">
                                                        <span className="text-4xl animate-bounce">â¬‡ï¸</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                            <div className="text-center mt-2 text-slate-500 text-sm font-medium bg-yellow-50 p-2 rounded-lg border border-yellow-100">
                                ğŸ’¡ æº«é¦¨æé†’ï¼šå¹³æ¿æ“ä½œè«‹ç”¨<b>ã€Œé»é¸ã€</b>å–ä»£æ‹–æ›³ï¼šå…ˆé»é¸ä¸Šæ–¹ç‰©è³ªï¼Œå†é»é¸ä¸‹æ–¹ç®±å­å³å¯ï¼
                            </div>
                        </div>
                    </div>
                );
            }

            if (screen === 'game-level-2') {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col">
                        {feedback && <FeedbackToast />}

                        <div className="bg-white shadow-sm p-4 flex justify-between items-center z-10">
                            <div className="font-bold text-slate-700 flex items-center gap-2">
                                <button onClick={() => setScreen('levels')} className="hover:bg-slate-100 p-2 rounded-lg">
                                    <Icons.ArrowRight className="rotate-180 w-5 h-5" />
                                </button>
                                Level 2: åŒ–å­¸é…å°å¯¦é©—å®¤
                            </div>
                            <div className="flex items-center gap-4">
                                <div className={`flex items-center gap-1 font-mono text-xl font-bold ${timeLeft < 10 ? 'text-red-500 animate-pulse-red' : 'text-slate-600'}`}>
                                    <Icons.Clock className="w-5 h-5" />
                                    {formatTime(timeLeft)}
                                </div>
                                <div className="font-black text-xl md:text-2xl text-purple-600 flex items-center gap-2">
                                    <div className="text-sm font-normal text-slate-400">ç›®å‰å¾—åˆ†:</div>
                                    {score}
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 p-4 max-w-6xl mx-auto w-full flex flex-col md:flex-row gap-6">
                            <div className="flex-1 bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                                <h3 className="text-lg font-bold text-slate-500 mb-4 flex items-center gap-2 shrink-0"><Icons.FlaskConical className="w-5 h-5" /> å¾…é…å°åŒ–å­¸å¼</h3>
                                <div className="grid grid-cols-2 lg:grid-cols-3 gap-3 content-start overflow-y-auto pr-2 no-scrollbar">
                                    {items.map(item => (
                                        <div
                                            key={item.id}
                                            onClick={() => handleItemClick(item)}
                                            className={`p-4 rounded-xl border-2 bg-slate-50 text-center cursor-pointer transition select-none
                                            ${draggedItem?.id === item.id ? 'border-purple-500 bg-purple-50 scale-105 ring-2 ring-purple-200' : 'border-slate-200 hover:bg-white hover:shadow-md'}
                                            `}
                                        >
                                            <div className="font-mono text-xl font-bold text-slate-700">{item.formula}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <div className="flex-1 bg-white rounded-3xl p-6 shadow-sm border border-slate-100 flex flex-col overflow-hidden">
                                <h3 className="text-lg font-bold text-slate-500 mb-4 flex items-center gap-2 shrink-0"><Icons.CheckCircle className="w-5 h-5" /> å®Œæˆå€ (ä¸­æ–‡/æ¨¡å‹)</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 overflow-y-auto pr-2 no-scrollbar content-start">
                                    {matchingData.map(target => {
                                        const isMatched = matchedPairs[target.id];
                                        return (
                                            <div
                                                key={target.id}
                                                onClick={() => handleSlotClick(target.id)}
                                                className={`p-3 rounded-xl border-2 flex items-center justify-between transition-all select-none
                                                    ${isMatched 
                                                    ? 'bg-green-50 border-green-200 opacity-80' 
                                                    : draggedItem 
                                                        ? 'border-purple-300 bg-purple-50 cursor-pointer border-dashed' 
                                                        : 'border-slate-100 bg-slate-50'}
                                                `}
                                            >
                                                <div className="flex items-center gap-3">
                                                    <div className="w-10 h-10 flex items-center justify-center bg-white rounded-lg shadow-sm border border-slate-100">
                                                        {target.model}
                                                    </div>
                                                    <span className="font-bold text-slate-700">{target.name}</span>
                                                </div>
                                                <div className={`px-4 py-2 rounded-lg font-mono font-bold min-w-[80px] text-center transition-all
                                                    ${isMatched ? 'bg-green-500 text-white scale-110 shadow-sm' : 'bg-slate-200 text-slate-400'}
                                                `}>
                                                    {isMatched ? isMatched.formula : '?'}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                        <div className="text-center mt-4 mb-4 text-slate-500 text-sm font-medium bg-yellow-50 p-2 rounded-lg border border-yellow-100 mx-4">
                            ğŸ’¡ æº«é¦¨æé†’ï¼šå¹³æ¿æ“ä½œè«‹ç”¨<b>ã€Œé»é¸ã€</b>å–ä»£æ‹–æ›³ï¼šå…ˆé»é¸å·¦å´åŒ–å­¸å¼ï¼Œå†é»é¸å³å´ç­”æ¡ˆæ ¼å³å¯ï¼
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MatterQuizApp />);
    </script>
</body>
</html>